<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="1:n key-value store for C++ and Java">
    <meta name="author" content="Martin Trenkmann">
    <link rel="icon" href="../favicon.ico">
    <title>Multimap</title>
    
    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    
    <!-- Bootstrap -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    
    <!-- highlight.js -->
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/googlecode.min.css">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <!-- Fonts -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Faster+One">
    <!--
    <link rel="stylesheet" href="https://code.cdn.mozilla.net/fonts/fira.css">
    Firefox Console: The stylesheet https://code.cdn.mozilla.net/fonts/fira.css
    was not loaded because its MIME type, "application/octet-stream", is not "text/css".
    -->
    <link rel="stylesheet" href="../fonts/fira.css">
    
    <!-- Customized Bootstrap style -->
    <link rel="stylesheet" href="../bootstrap-multimap.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script>
      function nbsp(n) {
        for (var i = 0; i < n; ++i) {
          document.write("&nbsp;");
        }
      }
      function year() {
        document.write(new Date().getFullYear());
      }
    </script>
  </head>
  
  <body data-spy="scroll" data-target="#multimap-sidebar" data-offset="50">
    <div id="main">
      <nav class="navbar navbar-inverse navbar-static-top">
        <div class="container">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#multimap-navbar-collapse" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">Multimap</span>
        </div>
        <div class="container">
          <div class="collapse navbar-collapse" id="multimap-navbar-collapse">
            <ul class="nav navbar-nav">
              
                
                  <li >
                    <a href="..">Home</a>
                  </li>
                
              
                
                  <li >
                    <a href="../overview/">Overview</a>
                  </li>
                
              
                
                  <li class="dropdown  active ">
                    <a href="#">Tutorials <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li class="dropdown-header">C++</li>
                          
                            <li >
                              <a href="../cppbasics/">Basics</a>
                            </li>
                          
                        
                      
                        
                          <li class="dropdown-header">Java</li>
                          
                            <li  class="active" >
                              <a href="./">Basics</a>
                            </li>
                          
                        
                      
                    </ul>
                  </li>
                
              
                
                  <li class="dropdown ">
                    <a href="#">Reference <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li >
                            <a href="../cppreference/">C++ Reference</a>
                          </li>
                        
                      
                        
                          <li >
                            <a href="../javareference/">Java Reference</a>
                          </li>
                        
                      
                    </ul>
                  </li>
                
              
                
                  <li class="dropdown ">
                    <a href="#">Installation <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                      
                        
                          <li >
                            <a href="../installation-linux/">GNU/Linux</a>
                          </li>
                        
                      
                        
                          <li >
                            <a href="../installation-osx/">OS X</a>
                          </li>
                        
                      
                    </ul>
                  </li>
                
              
              
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">GitHub <span class="caret"></span></a>
                <ul class="dropdown-menu">
                  <li><a href="https://github.com/mtrenkmann/multimap">View on GitHub</a></li>
                  <li><a href="https://github.com/mtrenkmann/multimap/issues">Create an Issue</a></li>
                  <li><a href="https://github.com/mtrenkmann/multimap/subscription">Watch this Project</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      
      
        <div class="container">
          <div class="row">
            
              <div class="col-md-9" role="main">
                <p><br></p>
<pre><code class="java">import io.multimap.Iterator;
import io.multimap.Map;
import io.multimap.Utils;
</code></pre>

<h2 id="creating-a-map">Creating a Map</h2>
<p>The minimal code to create a map is</p>
<pre><code class="java">Map.Options options = new Map.Options();
options.setCreateIfMissing(true);
Map map = new Map(&quot;path/to/directory&quot;, options);
</code></pre>

<p>However, you should also catch errors that may occur during construction.</p>
<pre><code class="java">Map map = null;
try {
  Map.Options options = new Map.Options();
  options.setCreateIfMissing(true);
  map = new Map(&quot;path/to/directory&quot;, options);
} catch (Exception e) {
  handleError(e);
}
</code></pre>

<h2 id="opening-a-map">Opening a Map</h2>
<p>To open an already existing map with default options you can simply omit the options parameter.</p>
<pre><code class="java">Map map = null;
try {
  map = new Map(&quot;path/to/directory&quot;);
} catch (Exception e) {
  handleError(e);
}
</code></pre>

<p>If the map does not exist, an exception will be thrown.</p>
<h2 id="closing-a-map">Closing a Map</h2>
<p>A map must be explicitly closed by calling its <code>close()</code> method in order to flush all data to disk and to ensure that the map is stored in consistent state. Not closing a map will cause data loss.</p>
<pre><code class="java">map.close();  // Never forget.
</code></pre>

<h2 id="putting-values">Putting Values</h2>
<p>Putting a value means to append a value to the end of the list that is associated with a key. Both the key and the value are of type <code>byte[]</code>.</p>
<pre><code class="java">map.put(Utils.toByteArray(&quot;key&quot;), Utils.toByteArray(&quot;value&quot;));
// Puts a value constructed from a string.

map.put(&quot;key&quot;, Utils.toByteArray(&quot;value2&quot;));
// There is an overload that accepts a key being a string.
// Internally the key is converted into a byte array as shown before.

map.put(&quot;key&quot;, Utils.toByteArray(Integer.toString(23)));
// Puts a value constructed from an integer.

map.put(&quot;key&quot;, ByteBuffer.allocate(4).putInt(23).array());
// Puts a value constructed from a java.nio.ByteBuffer.

map.put(&quot;key&quot;, somelib.serializeAsByteArray(someObject));
// Puts a value packed by some serialization library.
</code></pre>

<h2 id="getting-values">Getting Values</h2>
<p>Getting values means to request a read-only <a href="../javadoc/io/multimap/Iterator.html">Iterator</a> to the list associated with a key. If no such list exists the returned iterator points to an empty list. An iterator that points to a non-empty list holds a <a href="../overview#reader-lock">reader lock</a> on this list to synchronize concurrent access. A list can be read by multiple iterators from different threads at the same time. If an iterator is not needed anymore its <code>close()</code> method must be called in order to unlock the underlying list.</p>
<pre><code class="java">Iterator iter = map.get(key);

while (iter.hasNext()) {
  ByteBuffer value = iter.next();
  doSomething(value);
}

iter.close();  // Releases the internal reader lock.
</code></pre>

<p>A call to <code>next()</code> returns the next value as <code>java.nio.ByteBuffer</code>. This byte buffer is a direct one, which means that it wraps a pointer to memory allocated and managed by the native library. It is not backed by a <code>byte[]</code> managed by the Java Garbage Collector. Hence, the value is only valid as long as the iterator is not moving forward. You should never copy around this kind of byte buffer.</p>
<p>Things about iterators that are also worth noting:</p>
<ul>
<li>Iterators can tell the number of remaining values via <code>available()</code>.</li>
<li>Iterators can emit the next value without moving forward via <code>peekNext()</code>.</li>
<li>Calling <code>nextAsByteArray()</code> is a simple way to get a deep copy of the current value managed by the Java GC.</li>
<li>Iterators support lazy initialization which means that no I/O operation is performed until a value is actually requested via <code>next()</code> or <code>peekNext()</code>. This feature might be useful in cases where multiple iterators have to be collected first in order to decide in which order they need to be processed.</li>
<li>The lifetime of an iterator should be as short as possible to hold the internal reader lock on the underlying list no longer as needed. There are operations, such as remove and replace, which require exclusive access to lists, and which will block if the list in question is already locked.</li>
</ul>
<h2 id="removing-values">Removing Values</h2>
<p>Values can be removed from a list by injecting a <a href="../javadoc/io/multimap/Callables.Predicate.html">Predicate</a> which yields true for values to be removed. There are methods to remove only the first or all matches from a list. Since this is a mutating operation the methods require exclusive access to the list and therefore try to acquire a <a href="../overview#writer-lock">writer lock</a> for that list.</p>
<pre><code class="java">import io.multimap.Callables.Predicate;

map.put(key, Utils.toByteArray(&quot;1&quot;));
map.put(key, Utils.toByteArray(&quot;2&quot;));
map.put(key, Utils.toByteArray(&quot;3&quot;));
map.put(key, Utils.toByteArray(&quot;3&quot;));
map.put(key, Utils.toByteArray(&quot;4&quot;));
map.put(key, Utils.toByteArray(&quot;5&quot;));
map.put(key, Utils.toByteArray(&quot;6&quot;));

map.removeFirstEqual(key, Utils.toByteArray(&quot;3&quot;));
// Removes the first value equal to &quot;3&quot;.
// key -&gt; {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;}

Predicate isEven = new Predicate() {  
  @Override
  public boolean call(ByteBuffer value) {
    return Integer.parseInt(Utils.toString(value)) % 2 == 0;
  }
};

map.removeFirstMatch(key, isEven);
// Removes the first value that is even.
// key -&gt; {&quot;1&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;}

map.removeAllMatches(key, isEven);
// Removes all values that are even.
// key -&gt; {&quot;1&quot;, &quot;3&quot;, &quot;5&quot;}

map.remove(key);
// Removes all values associated with key.
// key -&gt; {}
</code></pre>

<p>When a value is removed it will only be marked as removed for the moment so that subsequent iterations will ignore it. Only an optimize operation triggered either via <a href="../javadoc/io/multimap/Map.html">API call</a> or the <a href="../overview#multimap-optimize">command line tool</a> will remove the data physically.</p>
<p>Note that if the list is already locked either by a <a href="../overview#reader-lock">reader</a> or <a href="../overview#writer-lock">writer lock</a> any remove operation on that list will block until the lock is released. A thread should never try to remove a value while owning an iterator to the same list to avoid deadlocks.</p>
<h2 id="replacing-values">Replacing Values</h2>
<p>Values can be replaced by injecting a <a href="../javadoc/io/multimap/Callables.Procedure.html">Procedure</a> that represents a map function which yields a <code>byte[]</code> for values to be replaced or <code>null</code> if not. There are methods to replace only the first or all matches in a list. Since this is a mutating operation these methods require exclusive access to a list and therefore try to acquire a <a href="../overview#writer-lock">writer lock</a> for the list in question.</p>
<p>When a value is replaced the old value is marked as removed and the new value is appended to the end of the list. Hence, replace operations will not preserve the order of values. If a certain order needs to be restored an <a href="../overview#multimap-optimize">optimize</a> operation has to be run parameterized with an appropriate <a href="../javadoc/io/multimap/Callables.LessThan.html">LessThan</a> function.</p>
<pre><code class="java">import io.multimap.Callables.Function;

map.put(key, Utils.toByteArray(&quot;1&quot;));
map.put(key, Utils.toByteArray(&quot;2&quot;));
map.put(key, Utils.toByteArray(&quot;3&quot;));
map.put(key, Utils.toByteArray(&quot;3&quot;));
map.put(key, Utils.toByteArray(&quot;4&quot;));
map.put(key, Utils.toByteArray(&quot;5&quot;));
map.put(key, Utils.toByteArray(&quot;6&quot;));

map.replaceFirstEqual(key, Utils.toByteArray(&quot;3&quot;), Utils.toByteArray(&quot;4&quot;));
// Replaces the first value equal to &quot;3&quot; by &quot;4&quot;.
// key -&gt; {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;4&quot;}

Function incrementIfEven = new Function() {  
  @Override
  public byte[] call(ByteBuffer value) {
    int number = Integer.parseInt(Utils.toString(value));
    return (number % 2 == 0) ? Utils.toByteArray(Integer.toString(number + 1)) : null;
  }
};

map.replaceFirstMatch(key, incrementIfEven);
// Replaces the first value that is even by its successor.
// key -&gt; {&quot;1&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;4&quot;, &quot;3&quot;}

map.replaceAllEqual(key, Utils.toByteArray(&quot;4&quot;), Utils.toByteArray(&quot;8&quot;));
// Replaces all values equal to &quot;4&quot; by &quot;8&quot;.
// key -&gt; {&quot;1&quot;, &quot;3&quot;, &quot;5&quot;, &quot;6&quot;, &quot;3&quot;, &quot;8&quot;, &quot;8&quot;}

map.replaceAllMatches(key, incrementIfEven);
// Replaces all values that are even by its successor.
// key -&gt; {&quot;1&quot;, &quot;3&quot;, &quot;5&quot;, &quot;3&quot;, &quot;7&quot;, &quot;9&quot;, &quot;9&quot;}
</code></pre>

<p>Note that if the list is already locked either by a <a href="../overview#reader-lock">reader</a> or <a href="../overview#writer-lock">writer lock</a> any replace method will block until the lock is released. A thread should never try to replace a value while owning an iterator to the same list to avoid deadlocks.</p>
              </div>
              <div class="col-md-3" role="complementary">
                <nav id="multimap-sidebar"
                     class="hidden-print hidden-xs hidden-sm affix-top"
                     data-spy="affix" data-offset-top="130" data-offset-bottom="200">
                  <ul class="nav">
                    
                      <li><a href="#creating-a-map">Creating a Map</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#opening-a-map">Opening a Map</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#closing-a-map">Closing a Map</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#putting-values">Putting Values</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#getting-values">Getting Values</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#removing-values">Removing Values</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                      <li><a href="#replacing-values">Replacing Values</a>
                        <ul>
                          
                        </ul>
                      </li>
                    
                  </ul>
                  <div id="back-to-top">
                    <a href="#top">Back to top</a>
                  </div>
                </nav>
              </div>
            
          </div>
        </div>
        <br>
        <br>
        <br>
      
    </div>
    
    <footer id="footer">
      <div class="container">
        <a href="http://www.gnu.org/licenses/agpl-3.0.en.html" target="_blank">
          <img style="float:right" src="../img/agpl-v3-logo-white-on-gray.png" />
        </a>
        <p>
          <i class="fa fa-copyright"></i> 2015-<script>year()</script> by <a href="https://github.com/mtrenkmann">Martin Trenkmann</a>
        </p>
        <p>Documentation built with <a href="http://getbootstrap.com/">Bootstrap</a>
          &middot; <a href="http://www.tipo.net.ar/">Faster One</a>
          &middot; <a href="http://www.carrois.com/fira-4-1/">Fira</a>
          &middot; <a href="http://fontawesome.io/">Font Awesome</a>
          &middot; <a href="https://highlightjs.org/">highlight.js</a>
          &middot; <a href="https://daringfireball.net/projects/markdown/">Markdown</a>
          &middot; <a href="http://www.mkdocs.org/">MkDocs</a></p>
      </div>
    </footer>
  </body>
</html>